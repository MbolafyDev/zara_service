{# templates/services/services.html #}
{% extends "base.html" %}
{% load static %}
{% load nombre %}

{% block title %}Liste des services{% endblock %}

{% block css_files %}
<style>
  .view-toggle .btn { padding:.375rem .6rem; }
  .view-toggle .btn.active { pointer-events:none; }
</style>
{% endblock css_files %}

{% block content %}
<div class="container mb-2">

  <h2 class="text-center">Liste des services</h2>

  {% include "includes/messages_alert.html" %}

  <div class="d-flex justify-content-between align-items-center mb-2">
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createModal">
      <i class="fa fa-plus"></i> Ajouter un service
    </button>

    {# üîÄ S√©lecteur d‚Äôaffichage style view-toggle #}
    <div id="displayToggle"
         class="view-toggle d-none d-lg-flex gap-1"
         data-storage-key="zr_display_services">
      <button type="button"
              class="btn btn-outline-primary {% if display_mode == 'auto' %}active{% endif %}"
              data-mode="auto" title="Auto">
        <i class="fa fa-magic"></i>
      </button>
      <button type="button"
              class="btn btn-outline-primary {% if display_mode == 'table' %}active{% endif %}"
              data-mode="table" title="Tableau">
        <i class="fa fa-table"></i>
      </button>
      <button type="button"
              class="btn btn-outline-primary {% if display_mode == 'cards' %}active{% endif %}"
              data-mode="cards" title="Cartes">
        <i class="fa fa-credit-card"></i>
      </button>
    </div>
  </div>

  <form id="servicesFilterForm" method="get" class="row g-2 mb-3" action="">
    <div class="col-md-6 col-lg-4">
      <input type="text" name="q" class="form-control" placeholder="Rechercher par nom" value="{{ query }}">
    </div>
    <div class="col-md-3 col-lg-2">
      <input type="number" name="tarif_min" class="form-control" step="100" placeholder="Tarif >=" value="{{ tarif_min }}">
    </div>
    <div class="col-md-3 col-lg-2">
      <input type="number" name="tarif_max" class="form-control" step="100" placeholder="Tarif <=" value="{{ tarif_max }}">
    </div>
    <div class="col-md-6 col-lg-2">
      <button type="submit" class="btn btn-outline-primary w-100">
        <i class="fa fa-filter"></i> Filtrer
      </button>
    </div>

    {# üîÅ Conserver le mode d‚Äôaffichage #}
    <input type="hidden" name="display" id="displayInput" value="{{ display_mode|default:'auto' }}">
  </form>

  {% if services %}
  {# ===== TABLE (lg+) ===== #}
  <div id="view-table"
       class="
         {% if display_mode == 'cards' %}d-none
         {% elif display_mode == 'table' %}d-block
         {% else %}d-none d-lg-block{% endif %}
       ">
    <div class="table-responsive">
      <table class="table table-bordered table-striped align-middle">
        <thead class="table-primary">
          <tr>
            <th>Nom</th>
            <th>R√©f√©rence</th>
            <th class="text-end">Tarif</th>
            <th class="text-center">Action</th>
          </tr>
        </thead>
        <tbody>
          {% for service in services %}
          <tr {% if service.statut_publication == 'supprim√©' %}style="text-decoration: line-through;"{% endif %}>
            <td>{{ service.nom }}</td>
            <td>{{ service.reference }}</td>
            <td class="text-end">{{ service.tarif|intpoint }}</td>
            <td class="text-center" style="white-space: nowrap">
              <button class="btn btn-sm btn-outline-primary me-1" data-bs-toggle="modal" data-bs-target="#editModal{{ service.id }}" {% if not is_admin or service.statut_publication == 'supprim√©' %}disabled{% endif %}>
                <i class="fa fa-edit"></i>
              </button>
              <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal{{ service.id }}" {% if not is_admin or service.statut_publication == 'supprim√©' %}disabled{% endif %}>
                <i class="fa fa-trash"></i>
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  {# ===== CARDS (mobile par d√©faut / forc√© si display=cards) ===== #}
  <div id="view-cards"
       class="
         {% if display_mode == 'table' %}d-none
         {% elif display_mode == 'cards' %}d-block
         {% else %}d-lg-none{% endif %}
       ">
    <div class="row">
      {% for service in services %}
      <div class="col-md-6 mb-4">
        <div class="card h-100 shadow-sm" {% if service.statut_publication == 'supprim√©' %}style="text-decoration: line-through;"{% endif %}>
          <div class="card-body">
            <h5 class="card-title text-primary">{{ service.nom }}</h5>
            <p class="mb-1"><strong>R√©f√©rence :</strong> {{ service.reference }}</p>
            <p class="mb-2"><strong>Tarif :</strong> {{ service.tarif|intpoint }} Ar</p>
          </div>
          <div class="card-footer text-end">
            <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editModal{{ service.id }}" {% if not is_admin or service.statut_publication == 'supprim√©' %}disabled{% endif %}>
              <i class="fa fa-edit"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal{{ service.id }}" {% if not is_admin or service.statut_publication == 'supprim√©' %}disabled{% endif %}>
              <i class="fa fa-trash"></i>
            </button>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  {# Modals #}
  {% for service in services %}
    {% include "vente/includes/edit_modal.html" with service=service %}
    {% include "vente/includes/delete_modal.html" with service=service %}
  {% endfor %}

  {% else %}
    <div class="alert alert-info text-center">Aucun service enregistr√©.</div>
  {% endif %}

  {% include "common/includes/pagination.html" with page_obj=page_obj extra_querystring=extra_querystring %}

</div>

{# Modal cr√©ation #}
<div class="modal fade" id="createModal" tabindex="-1" aria-labelledby="createModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form method="post" action="{% url 'create_services' %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="createModalLabel">Ajouter un service</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="nom" class="form-label">Nom</label>
            <input type="text" class="form-control" id="nom" name="nom" required>
          </div>
          <div class="mb-3">
            <label for="reference" class="form-label">R√©f√©rence</label>
            <input type="text" class="form-control" id="reference" name="reference">
          </div>
          <div class="mb-3">
            <label for="tarif" class="form-label">Tarif</label>
            <input type="number" class="form-control" id="tarif" name="tarif" step="100">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="submit" class="btn btn-primary">Ajouter le service</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  (function() {
    const toggle = document.getElementById('displayToggle');
    const input  = document.getElementById('displayInput');
    const form   = document.getElementById('servicesFilterForm');
    // Base URL fiable (√©vite les surprises avec action="")
    const baseUrl = "{% url 'services' %}";

    if (!toggle || !form || !input) return;

    const storageKey = toggle.dataset.storageKey || 'zr_display_services';
    const validModes = ['auto', 'table', 'cards'];

    // Init: si pas de ?display= dans l‚ÄôURL, charger la valeur locale + activer le bon bouton
    (function bootstrapDisplay() {
      const urlParams = new URLSearchParams(window.location.search);
      const urlDisplay = (urlParams.get('display') || '').toLowerCase();
      const mode = urlDisplay || localStorage.getItem(storageKey);

      if (mode && validModes.includes(mode)) {
        input.value = mode;
        const btn = toggle.querySelector(`button[data-mode="${mode}"]`);
        if (btn) {
          toggle.querySelectorAll('button').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
        }
      }
    })();

    function buildAndNavigate() {
      const fd = new FormData(form);
      const params = new URLSearchParams();
      for (const [k, v] of fd.entries()) {
        if (v !== null && String(v).trim() !== '') params.append(k, v);
      }
      const url = params.toString() ? `${baseUrl}?${params}` : baseUrl;
      window.location.href = url;
    }

    toggle.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-mode]');
      if (!btn) return;

      const mode = (btn.dataset.mode || '').toLowerCase();
      if (!validModes.includes(mode)) return;

      toggle.querySelectorAll('button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      localStorage.setItem(storageKey, mode);
      input.value = mode;

      buildAndNavigate();
    });
  })();
</script>

{% endblock %}
