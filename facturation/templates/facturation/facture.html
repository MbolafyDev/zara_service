{% load static %}
{% load nombre %}
{% load custom_filters %}

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Factures</title>
    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
            font-size: 16px;
            background: white;
            color: #000;
        }

        .page {
            max-width: 720px;
            margin: auto;
            page-break-after: always;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        thead { color: #000000; }
        tfoot { color: #000000; }

        th, td {
            border: 1px solid #000;
            padding: 8px;
        }

        .text-center { text-align: center; }
        .text-end { text-align: right; }
        .fw-bold { font-weight: bold; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-4 { margin-top: 1.5rem; }
        .mt-5 { margin-top: 3rem; }

        .signature { height: 200px; }

        .tampon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            height: 100px;
            opacity: 0.8;
            z-index: 0;
            pointer-events: none;
        }

        .position-relative { position: relative; }

        @media print {
            body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
        .info-client td{
            border: none;
            padding: 0;
            vertical-align: top;          /* aligne en haut */
        }
        .info-client td:first-child{
            white-space: nowrap;          /* garde la largeur “Raison sociale :” */
            padding-right: 6px;
        }
        .info-client td:last-child{
            overflow-wrap: anywhere;      /* casse proprement email/adresse longs */
            word-break: break-word;
        }
    </style>
</head>
<body {% if impression %}onload="window.print()"{% endif %}>

{% for commande in commandes %}
<div class="page">
    <div style="display: flex; width: 100%; align-items: center;">
        <!-- Bloc logo + infos page -->
        <div style="flex: 3; display: flex; align-items: center; gap: 10px;">
            <div class="me-2">
                <img src="{% static 'images/logo_harena.png' %}" alt="Logo" style="height: 120px;">
            </div>
            <div class="ms-2">
                <p style="margin: 0; font-size: large; margin-bottom: 5px;">HARENA Consulting SARLU</p>
                <p style="margin: 0; font-size: medium;">Lot II M 92 Antsakaviro Ambodiroatra</p>
                <p style="margin: 0; font-size: medium;">NIF : 3012415421 - STAT : 70202 11 2022 0 11431</p>
                <p style="margin: 0; font-size: medium;">Téléphone :      +261 38 92 993 00</p>
                <p style="margin: 0; font-size: medium;">E-mail :         rh.harena@gmail.com</p>
            </div>
        </div>

    </div>

    <div class="mt-2" style="display: flex; width: 100%;">
        <div style="flex: 2; margin-right: 10px;">
            <p style="text-align: right; margin:0;"><strong>DOIT :</strong></p>
        </div>
        <div style="flex: 3;">
            <table class="info-client" style="border: none; border-collapse: collapse; width: 100%; margin:0; padding:0;">

                <tr>
                    <td style="border:none; padding:0; white-space:nowrap;">Raison sociale : &nbsp;</td>
                    <td style="border:none; padding:0;">{{ commande.client.raison_sociale }}</td>
                </tr>

                {% if commande.client.nif %}
                <tr>
                    <!-- Les autres libellés peuvent revenir à la ligne pour ne pas élargir la colonne -->
                    <td style="border:none; padding:0; white-space:normal;">NIF :</td>
                    <td style="border:none; padding:0;">{{ commande.client.nif }}</td>
                </tr>
                {% endif %}

                {% if commande.client.stat %}
                <tr>
                    <td style="border:none; padding:0; white-space:normal;">STAT :</td>
                    <td style="border:none; padding:0;">{{ commande.client.stat }}</td>
                </tr>
                {% endif %}

                {% if commande.client.rcs %}
                <tr>
                    <td style="border:none; padding:0; white-space:normal;">RCS :</td>
                    <td style="border:none; padding:0;">{{ commande.client.rcs }}</td>
                </tr>
                {% endif %}

                {% if commande.client.adresse %}
                <tr>
                    <td style="border:none; padding:0; white-space:normal;">Adresse :</td>
                    <td style="border:none; padding:0;">{{ commande.client.adresse }}</td>
                </tr>
                {% endif %}

                {% if commande.client.email %}
                <tr>
                    <td style="border:none; padding:0; white-space:normal;">Email :</td>
                    <td style="border:none; padding:0;">{{ commande.client.email }}</td>
                </tr>
                {% endif %}

                {% if commande.client.telephone %}
                <tr>
                    <td style="border:none; padding:0; white-space:normal;">Téléphone :</td>
                    <td style="border:none; padding:0;">{{ commande.client.telephone }}</td>
                </tr>
                {% endif %}
            </table>
        </div>
    </div>

    <div style="display: flex; width: 100%;">
        <div style="flex: 2;">
            <h1 style="margin-bottom: 5px;">{{ type_facture }}</h1>
            <table>
                <tr class="fw-bold" style="background-color: lightgray;">
                    <td>NUMERO</td>
                    <td>DATE</td>
                </tr>
                <tr>
                    <td>
                        {% if type_facture == "FACTURE" and commande.vente.numero_facture %}
                            {{ commande.vente.numero_facture }}
                        {% else %}
                            {{ commande.numero_proforma }}
                        {% endif %}
                    </td>
                    <td>
                        {% if type_facture == "FACTURE" %}
                            {% if commande.vente and commande.vente.date_encaissement %}
                                {{ commande.vente.date_encaissement|date:"d/m/Y" }}
                            {% else %}
                                {{ commande.date_commande|date:"d/m/Y" }}
                            {% endif %}
                        {% else %}
                            {{ commande.date_commande|date:"d/m/Y" }}
                        {% endif %}
                    </td>
                </tr>
            </table>
        </div>
        <div style="flex: 2;"></div>
    </div>

    <div class="position-relative mt-4">
        {% comment %} {% if type_facture == "FACTURE" and commande.statut_vente == "Payée" %}
        <img src="{% static 'images/paye.png' %}" alt="Tampon" class="tampon">
        {% endif %} {% endcomment %}
        <table>
            <thead style="background-color: lightgray;">
                <tr class="text-center">
                    <th style="width: 5%;">N°</th>
                    <th>Désignation</th>
                    <th style="width: 20%;">P.U (Ar)</th>
                    <th style="width: 10%;">Qté</th>
                    <th style="width: 20%;">Montant (Ar)</th>
                </tr>
            </thead>
            <tbody>
                {% for ligne in commande.lignes_commandes.all %}
                <tr>
                    <td class="text-center">{{ forloop.counter }}</td>
                    <td>{{ ligne.service.nom|default:ligne.service }}</td>
                    <td class="text-end">{{ ligne.tarif|intpoint }}</td>
                    <td class="text-center">{{ ligne.quantite }}</td>
                    <td class="fw-bold text-end">{{ ligne.montant|intpoint }}</td>
                </tr>
                {% endfor %}

                {% comment %} {# Remplissage jusqu’à 10 lignes visibles #}
                {% with nb=commande.lignes_commandes.count %}
                    {% for i in "0123456789" %}
                        {% if forloop.counter > nb %}
                            <tr><td>&nbsp;</td><td></td><td></td><td></td><td></td></tr>
                        {% endif %}
                    {% endfor %}
                {% endwith %} {% endcomment %}
            </tbody>
            {% comment %} <tfoot style="background-color: {{ commande.page.nom|couleur_page }};" class="fw-bold">
                <tr>
                    <td colspan="4" class="text-center">TOTAL</td>
                    <td class="text-end">{{ commande.montant_commande|intpoint }}</td>
                </tr>
            </tfoot> {% endcomment %}
        </table>
        <br>
        <table>
            <tr>
                {% if type_facture == "FACTURE PROFORMA" %}
                <td style="padding-top: 0; padding-bottom: 0;">
                    <p class="fw-bold">Mode de règlement : </p>
                    <b>Espèce / MVola / Orange Money </b>
                    <p>A LA RECEPTION DE LA FACTURE</p>
                </td>
                {% else %}
                <td style="border-left: 0; border-top:0; border-bottom: 0; padding-top: 0; padding-bottom: 0;"></td>
                {% endif %}
                <td style="width: 30%; text-align: right; padding-top: 0; padding-bottom: 0;" class="fw-bold">
                    <p>Montant HT</p>
                    <p>TVA</p>
                    <p>Montant TTC</p>
                </td>
                <td style="width: 20%; text-align: right; padding-top: 0; padding-bottom: 0;" class="fw-bold">
                    <p>{{ commande.montant_commande|intpoint }}</p>
                    <p>-</p>
                    <p>{{ commande.montant_commande|intpoint }}</p>
                </td>
            </tr>
        </table>
    </div>

    <p class="mt-4">
        Arrêtée la présente facture à la somme de <strong>{{ commande.montant_commande|int2words }} Ariary</strong>.
    </p>

    <div class="mt-5" style="display: flex; justify-content: space-between; text-align: center;">
        <div>
            <p style="text-decoration: underline;"><strong>Le client</strong></p>
        </div>
        <div style="text-align: center;">
    <p style="text-decoration: underline; margin-bottom: 10px;"><strong>Le prestataire</strong></p>

    <div style="position: relative; display: inline-block;">
            <img src="{% static 'images/signature_harena.png' %}" alt="Signature" class="signature">
            <span style="position: absolute; top: 80px; left: 50%; transform: translateX(-50%); color: #000; white-space: nowrap;">
                TOVOMAMINIAINA Jocelin <br>Gérant
            </span>
        </div>
    </div>

    </div>

    <!-- Bloc mode de paiement (automatique depuis la BDD) -->
    <div style="margin-top: 40px; text-align: left;">
        {% if caisses %}
            <div style="display:flex; align-items:center; flex-wrap:wrap; gap:20px; margin-top:5px;">
                <span style="font-weight:bold;">Mode de paiement :</span>
                {% for caisse in caisses %}
                    <label style="display:inline-flex; align-items:center; gap:5px; white-space:nowrap;">
                        <input type="checkbox"
                            {% if type_facture == "FACTURE" and commande.vente and commande.vente.paiement_id == caisse.id %}checked{% endif %}>
                        <span>{{ caisse.nom }}</span>
                    </label>
                {% endfor %}
            </div>
        {% else %}
            <div></div>
        {% endif %}
    </div>

    <!-- Référence paiement -->
    <div>
        {% if type_facture == "FACTURE" and commande.vente.reference %}
        <p>Référence du paiement : <span style="color: gray; text-decoration:underline dotted;">{{ commande.vente.reference }} </span></p>
        {% endif %}
    </div>

</div>
{% endfor %}

</body>
</html>
